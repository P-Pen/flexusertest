import{r as P,J as V,o as r,g as m,a as e,u as s,b as o,w as n,c as f,h as c,d as g,f as d,F as w,D as q,t as h,e as I,bb as U,i as D,L as j}from"./app-BYx064nO.js";import{i as K,c as W}from"./app-DISTCiac.js";import{_ as X}from"./app-BAIc7wsg.js";import{_ as Y}from"./app-_N2IGwgj.js";import{_ as Z}from"./app-C7gR9zYq.js";import{_ as ee}from"./app-57xpzLDR.js";import{_ as k}from"./app--BlRpVz_.js";import{_ as te}from"./app-Bx5jiAm1.js";import{_ as se}from"./app-1SA4suwN.js";import{_ as M}from"./app-C5GVF480.js";import{T as L,a as $}from"./app-DRGtcCVV.js";import{_ as A}from"./app-Bg2kbTeB.js";import{D as le}from"./app-D0jdtzyy.js";import{_ as F,a as b}from"./app-BuHt2kYS.js";import{T as N}from"./app-DoTJvLi7.js";import{a as oe,_ as ne}from"./app-Dj8c2KwC.js";import{C as S}from"./app-D2_aZ1I5.js";import{C as E}from"./app-DzOFJRH2.js";import{_ as ae}from"./app-GoR2fTOd.js";import{T as Q}from"./app-C9w-bzHc.js";import{T as B}from"./app-DR284fT9.js";import{_ as G}from"./app-B-EzfWu7.js";import{_ as H}from"./app-x_fVWXrx.js";import"./app-BXvxi6wb.js";import"./app-5V9SnxW6.js";import"./app-DOaxShSm.js";import"./app-DQhYsbJs.js";import"./app-BXiLqtxA.js";import"./app-CqvvE0jO.js";import"./app-CK9Tk_hc.js";import"./app-CAeEyuA3.js";import"./app-DoRtcMJm.js";import"./app-DPMEyUYH.js";import"./app-tUtHmy3n.js";import"./app-DYkSpHuE.js";import"./app-DNadG4GC.js";import"./app-TBcc1obG.js";import"./app-51hQc1Cd.js";import"./app-CqAVEB_b.js";import"./app-Cqxz9tud.js";import"./app-aIb4ksxL.js";import"./app-DyIe33QU.js";import"./app-cRxw2ZDj.js";function ue(){const{utils:_}=K(this);this.success=this.$NotifyReloadSuccess("保存成功"),this.tab="ipStat",this.changeTab=function(){this.tab=="events"&&this.hasUnreadEvents&&(this.hasUnreadEvents=!1,this.$post(".updateRead").params({serverId:this.serverId}))},this.createIPItem=function(p,v){const t=Math.round(new Date().getTime()/1e3)+86400;_.popup("/servers/iplists/createIPPopup?listId="+p+"&serverId="+this.serverId+"&ip="+v+"&expiresAt="+t+"&reason=疑似CC攻击&sourceCategory=cc",{height:_.POPUP_HEIGHT_LG,callback:function(){_.successRefresh("操作成功")}})},this.createIPMenu=function(p){return[{label:"拉黑IP",command:()=>{this.createIPItem(this.denyListId,p)},icon:"pi pi-ban"}]},this.createIPItemMenu=function(p){return[{label:"解除拦截",command:()=>{const v=[];this.deniedIPItems.forEach(function(t){t.id!=p&&v.push(t)}),this.$post(".deleteIPItem").params({itemId:p}).success(function(){_.success("解除成功",function(){this.deniedIPItems=v})})},icon:"pi pi-ban"}]}}const ie=["value"],re=e("td",{class:"title"},"启用CC无感防护",-1),de=e("p",{class:"comment"}," 启用后，自动检测并拦截CC攻击。 ",-1),me=e("td",null,"阈值设置",-1),ce={key:0,class:"comment"},he={key:0},fe={key:0},_e={key:1,class:"comment"},pe={key:2,class:"comment"},ve=e("td",{class:"color-border"},"自定义拦截阈值设置",-1),Pe=e("span",null,"单IP每5秒最多",-1),ge=e("span",null,"请求",-1),Ie={style:{"margin-top":"1em"}},ye=e("span",null,"单IP每60秒最多",-1),xe=e("span",null,"请求",-1),Re={style:{"margin-top":"1em"}},$e=e("span",null,"单IP每300秒最多",-1),be=e("span",null,"请求",-1),Ve=e("td",null,"拦截强度",-1),Ce={class:"comment"},Te={key:0},Ue={key:1},ke={colspan:"2"},Me=e("td",null,"例外URL",-1),Le=e("p",{class:"comment"},"如果填写了例外URL，表示这些URL跳过CC防护不做处理。",-1),we=e("td",null,"限制URL",-1),qe=e("p",{class:"comment"},"如果填写了限制URL，表示只对这些URL进行CC防护处理；如果不填则表示支持所有的URL。",-1),Oe=e("td",null,"忽略常用文件",-1),Ne=e("p",{class:"comment"},"忽略js、css、jpg等常在网页里被引用的文件名，即对这些文件的访问不加入计数，可以减少误判几率。但如果单独访问这些文件，比如在浏览器里直接打开，也会加入计数。",-1),Se=e("td",null,"检查请求来源指纹",-1),Ee=e("p",{class:"comment"},"在接收到HTTPS请求时尝试检查请求来源的指纹，用来检测代理服务和爬虫攻击；如果你在网站前面放置了别的反向代理服务，请取消此选项。",-1),Ge=e("td",null,"启用GET302校验",-1),De=e("p",{class:"comment"},"选中后，表示自动通过GET302方法来校验客户端。",-1),Ae=e("td",null,"单IP最低QPS",-1),Fe=e("span",null,"请求数/秒",-1),Qe=e("p",{class:"comment"},"当某个IP在1分钟内平均QPS达到此值时，才会开始检测；如果设置为0，表示任何访问都会检测。（注意这里设置的是检测开启阈值，不是拦截阈值，拦截阈值请选择表单上方的“阈值设置“--“自定义”）",-1),Be={__name:"HTTPCCConfigBox",props:["v-cc-config","v-is-location","v-is-group","defaultThresholds"],setup(_){const p=_,v=function(l,u){if(l.thresholds==null)return"";if(u<l.thresholds.length){let a=l.thresholds[u].maxRequests.toString();return a=="0"&&(a=""),a}return""},{config:t,moreOptionsVisible:C,minQPSPerIP:R,useCustomThresholds:i,thresholdMaxRequests0:y,thresholdMaxRequests1:x,thresholdMaxRequests2:T}=function(){let l=p.vCcConfig;return l==null&&(l={isPrior:!1,isOn:!1,enableFingerprint:!0,enableGET302:!0,onlyURLPatterns:[],exceptURLPatterns:[],useDefaultThresholds:!0,ignoreCommonFiles:!0,thresholdMethod:"default",level:"low"}),(l.thresholds==null||l.thresholds.length==0)&&(l.thresholds=[{maxRequests:0},{maxRequests:0},{maxRequests:0}]),typeof l.enableFingerprint!="boolean"&&(l.enableFingerprint=!0),typeof l.enableGET302!="boolean"&&(l.enableGET302=!0),l.onlyURLPatterns==null&&(l.onlyURLPatterns=[]),l.exceptURLPatterns==null&&(l.exceptURLPatterns=[]),l.thresholdMethod||(l.useDefaultThresholds?l.thresholdMethod="auto":l.thresholdMethod="custom"),l.level||(l.level="low"),{config:P(l),moreOptionsVisible:P(!1),minQPSPerIP:P(l.minQPSPerIP),useCustomThresholds:P(!l.useDefaultThresholds),thresholdMaxRequests0:P(v(l,0)),thresholdMaxRequests1:P(v(l,1)),thresholdMaxRequests2:P(v(l,2))}}(),O=function(l,u){let a=parseInt(u);(isNaN(a)||a<0)&&(a=0),l<t.value.thresholds.length&&(t.value.thresholds[l].maxRequests=a)},z=function(){C.value=!C.value};return V(R,function(l){let u=parseInt(l.toString());(isNaN(u)||u<0)&&(u=0),t.value.minQPSPerIP=u}),V(y,function(l){O(0,l)}),V(x,function(l){O(1,l)}),V(T,function(l){O(2,l)}),V(i,function(l){t.value.useDefaultThresholds=!l}),(l,u)=>(r(),m("div",null,[e("input",{type:"hidden",name:"ccJSON",value:JSON.stringify(s(t))},null,8,ie),o(le,null,{default:n(()=>[l.vIsLocation||l.vIsGroup?(r(),f(te,{key:0,"v-config":s(t)},null,8,["v-config"])):c("",!0),g(e("tbody",null,[e("tr",null,[re,e("td",null,[o(k,{modelValue:s(t).isOn,"onUpdate:modelValue":u[0]||(u[0]=a=>s(t).isOn=a)},null,8,["modelValue"]),de])]),g(e("tr",null,[me,e("td",null,[o(F,{modelValue:s(t).thresholdMethod,"onUpdate:modelValue":u[1]||(u[1]=a=>s(t).thresholdMethod=a)},{default:n(()=>[o(b,{value:"default"},{default:n(()=>[d("默认")]),_:1}),o(b,{value:"auto"},{default:n(()=>[d("自动")]),_:1}),o(b,{value:"custom"},{default:n(()=>[d("自定义")]),_:1})]),_:1},8,["modelValue"]),s(t).thresholdMethod=="default"?(r(),m("p",ce,[d(" 使用系统默认的阈值设置。 "),_.defaultThresholds&&_.defaultThresholds.length>0?(r(),m("span",he,[d(" 当前系统默认阈值设置：单IP"),(r(!0),m(w,null,q(_.defaultThresholds,(a,J)=>(r(),m("span",null,[d(" 每 "+h(a.periodSeconds)+" 秒 最多 "+h(a.maxRequests)+" 请求",1),J<_.defaultThresholds.length-1?(r(),m("span",fe,"；")):c("",!0)]))),256)),d("。 ")])):c("",!0)])):c("",!0),s(t).thresholdMethod=="auto"?(r(),m("p",_e,"系统根据网站访问量自动动态设置阈值。")):c("",!0),s(t).thresholdMethod=="custom"?(r(),m("p",pe,"手动自定义阈值。")):c("",!0)])],512),[[I,s(t).isOn]]),g(e("tr",null,[ve,e("td",null,[e("div",null,[o(L,null,{default:n(()=>[o($,null,{default:n(()=>[Pe]),_:1}),o(M,{type:"text",style:{width:"6em"},maxlength:"6",modelValue:s(y),"onUpdate:modelValue":u[2]||(u[2]=a=>U(y)?y.value=a:null)},null,8,["modelValue"]),o($,null,{default:n(()=>[ge]),_:1})]),_:1})]),e("div",Ie,[o(L,null,{default:n(()=>[o($,null,{default:n(()=>[ye]),_:1}),o(M,{type:"text",style:{width:"6em"},maxlength:"6",modelValue:s(x),"onUpdate:modelValue":u[3]||(u[3]=a=>U(x)?x.value=a:null)},null,8,["modelValue"]),o($,null,{default:n(()=>[xe]),_:1})]),_:1})]),e("div",Re,[o(L,null,{default:n(()=>[o($,null,{default:n(()=>[$e]),_:1}),o(M,{type:"text",style:{width:"6em"},maxlength:"6",modelValue:s(T),"onUpdate:modelValue":u[4]||(u[4]=a=>U(T)?T.value=a:null)},null,8,["modelValue"]),o($,null,{default:n(()=>[be]),_:1})]),_:1})])])],512),[[I,s(t).isOn&&s(t).thresholdMethod=="custom"]]),g(e("tr",null,[Ve,e("td",null,[o(F,{modelValue:s(t).level,"onUpdate:modelValue":u[5]||(u[5]=a=>s(t).level=a)},{default:n(()=>[o(b,{value:"low"},{default:n(()=>[d("低")]),_:1}),o(b,{value:"middle"},{default:n(()=>[d("中")]),_:1}),o(b,{value:"high"},{default:n(()=>[d("高")]),_:1})]),_:1},8,["modelValue"]),e("p",Ce,[d("级别越高"),s(t).thresholdMethod=="auto"?(r(),m("span",Te,"，CC检测越灵敏")):c("",!0),d("，被拦截的IP封禁时间"),s(t).thresholdMethod=="auto"?(r(),m("span",Ue,"也会")):c("",!0),d("越长。 ")])])],512),[[I,s(t).isOn]])],512),[[I,!l.vIsLocation&&!l.vIsGroup||s(t).isPrior]]),g(e("tbody",null,[e("tr",null,[e("td",ke,[o(se,{onChange:z})])])],512),[[I,s(t).isOn]]),g(e("tbody",null,[e("tr",null,[Me,e("td",null,[o(A,{modelValue:s(t).exceptURLPatterns,"onUpdate:modelValue":u[6]||(u[6]=a=>s(t).exceptURLPatterns=a)},null,8,["modelValue"]),Le])]),e("tr",null,[we,e("td",null,[o(A,{modelValue:s(t).onlyURLPatterns,"onUpdate:modelValue":u[7]||(u[7]=a=>s(t).onlyURLPatterns=a)},null,8,["modelValue"]),qe])]),e("tr",null,[Oe,e("td",null,[o(k,{modelValue:s(t).ignoreCommonFiles,"onUpdate:modelValue":u[8]||(u[8]=a=>s(t).ignoreCommonFiles=a)},null,8,["modelValue"]),Ne])]),e("tr",null,[Se,e("td",null,[o(k,{modelValue:s(t).enableFingerprint,"onUpdate:modelValue":u[9]||(u[9]=a=>s(t).enableFingerprint=a)},null,8,["modelValue"]),Ee])]),e("tr",null,[Ge,e("td",null,[o(k,{modelValue:s(t).enableGET302,"onUpdate:modelValue":u[10]||(u[10]=a=>s(t).enableGET302=a)},null,8,["modelValue"]),De])]),e("tr",null,[Ae,e("td",null,[o(L,null,{default:n(()=>[o(M,{type:"text",name:"minQPSPerIP",maxlength:"6",style:{width:"6em"},modelValue:s(R),"onUpdate:modelValue":u[11]||(u[11]=a=>U(R)?R.value=a:null)},null,8,["modelValue"]),o($,null,{default:n(()=>[Fe]),_:1})]),_:1}),Qe])])],512),[[I,s(C)&&s(t).isOn]])]),_:1})]))}},He={key:0,class:"pi pi-circle-fill text-red-400 dark:text-red-600",style:{"font-size":"0.1em"}},ze={class:"my-4"},Je=e("span",{class:"text-sm gray"},"（访问量为估算）",-1),je={class:"mt-2 flex flex-col gap-3 text-surface"},Ke={class:"font-medium"},We=["href"],Xe=e("span",{class:"red font-normal text-sm ml-2"},"已拦截",-1),Ye=[Xe],Ze=["href"],et=e("span",{class:"green font-normal text-sm ml-2"},"已放行",-1),tt=[et],st={class:"font-medium text-surface"},lt=["href"],ot=e("span",{class:"red font-normal text-sm ml-2"},"已拦截",-1),nt=[ot],at={class:"mt-2 flex flex-col gap-3 text-surface"},ut={key:0},it={key:1},rt={key:2},dt={class:"flex flex-col gap-3 text-surface"},mt={class:"font-medium"},ct={key:0},ht=["value"],ft={key:1},os={__name:"index",setup(_){const p=P(),v=P(),t=W(new ue);return(C,R)=>(r(),f(X,{ctx:s(t)},{default:n(()=>[o(ne,{modelValue:s(t).tab,"onUpdate:modelValue":R[0]||(R[0]=i=>s(t).tab=i),onChange:s(t).changeTab},{default:n(()=>[o(oe,null,{default:n(()=>[o(N,{code:"ipStat"},{default:n(()=>[d("IP即时统计")]),_:1}),o(N,{code:"deniedIP"},{default:n(()=>[d("被拦截IP")]),_:1}),o(N,{code:"events"},{default:n(()=>[d("检测事件 "),s(t).hasUnreadEvents?(r(),m("i",He)):c("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue","onChange"]),e("div",ze,[g(e("div",null,[s(t).topIPStats&&s(t).topIPStats.length>0?(r(),f(S,{key:0},{header:n(()=>[d("最近5分钟访问量IP排行"),Je]),default:n(()=>[(r(!0),m(w,null,q(s(t).topIPStats,(i,y)=>(r(),f(E,null,{name:n(()=>[e("div",null,[o(ae,{class:"!h-1.5 lg:w-[14em]",value:i.percent,"show-value":!1},null,8,["value"]),e("div",je,[e("div",Ke,[d(" IP："+h(i.ip)+" ",1),i.isDenied?(r(),m("a",{key:0,href:"/servers/iplists?ip="+i.ip,target:"_blank"},Ye,8,We)):c("",!0),i.isAllowed?(r(),m("a",{key:1,href:"/servers/iplists?ip="+i.ip,target:"_blank"},tt,8,Ze)):c("",!0),o(Q,{ref_for:!0,ref_key:"ipMenuRef",ref:p,items:s(t).createIPMenu(i.ip),popup:!0},null,8,["items"]),!i.isDenied&&!i.isAllowed?(r(),f(B,{key:2,icon:"pi pi-ellipsis-v",link:"",size:"small",onClick:D(x=>p.value[y].toggle(x),["prevent"])},null,8,["onClick"])):c("",!0)]),e("div",null,"平均访问量："+h(s(t).$utils.formatNumber(i.avgRequests))+"/秒",1),e("div",null,"总访问量："+h(s(t).$utils.formatNumber(i.countRequests)),1),e("div",null,"IP信息："+h(i.summary),1)])])]),_:2},1024))),256))]),_:1})):(r(),f(G,{key:1},{default:n(()=>[d("暂时还没有需要被关注的IP。不展示访问量较小的IP。")]),_:1}))],512),[[I,s(t).tab=="ipStat"]]),g(e("div",null,[s(t).deniedIPItems&&s(t).deniedIPItems.length>0?(r(),f(S,{key:0},{header:n(()=>[d("最近被拦截的IP")]),default:n(()=>[(r(!0),m(w,null,q(s(t).deniedIPItems,(i,y)=>(r(),f(E,null,{name:n(()=>[e("div",st,[d(" IP："+h(i.ip)+" ",1),e("a",{href:"/servers/iplists?ip="+i.ip,target:"_blank"},nt,8,lt),o(Q,{ref_for:!0,ref_key:"ipItemMenuRef",ref:v,items:s(t).createIPItemMenu(i.id),popup:!0},null,8,["items"]),o(B,{icon:"pi pi-ellipsis-v",link:"",size:"small",onClick:D(x=>v.value[y].toggle(x),["prevent"])},null,8,["onClick"])]),e("div",at,[e("div",null,"IP信息："+h(i.summary),1),e("div",null,"有效期至："+h(i.expiresTime),1),i.reason&&i.reason.length>0?(r(),m("div",ut,"拦截原因："+h(i.reason),1)):c("",!0),i.sourceURL?(r(),m("div",it,[d("URL："+h(i.sourceURL)+" ",1),o(H,{content:"被封禁时访问的URL，但并不代表该IP只访问了这一个URL。"})])):c("",!0),i.sourceUserAgent?(r(),m("div",rt,[d("客户端信息："+h(i.sourceUserAgent)+" ",1),o(H,{content:"被封禁时访问的UserAgent，但并不代表该IP只使用这一个UserAgent。"})])):c("",!0)])]),_:2},1024))),256))]),_:1})):(r(),f(G,{key:1},{default:n(()=>[d("暂时还没有CC相关被拦截的IP。")]),_:1}))],512),[[I,s(t).tab=="deniedIP"]]),g(e("div",null,[s(t).events&&s(t).events.length>0?(r(),f(S,{key:0},{header:n(()=>[d("检测到的CC事件")]),default:n(()=>[(r(!0),m(w,null,q(s(t).events,i=>(r(),f(E,null,{name:n(()=>[e("div",dt,[e("div",mt,"5分钟内访问量："+h(s(t).$utils.formatNumber(i.params.requests)),1),e("div",null,"平均访问量："+h(s(t).$utils.formatNumber(i.params.avgRequests))+"/秒",1),e("div",null,"触发时间："+h(i.createdTime),1)])]),_:2},1024))),256))]),_:1})):(r(),f(G,{key:1},{default:n(()=>[d("暂时还没有检测到CC事件。")]),_:1}))],512),[[I,s(t).tab=="events"]])]),o(j),s(t).featureIsOn?(r(),m("div",ct,[o(Y,{action:"$",onSuccess:s(t).success},{default:n(()=>[e("input",{type:"hidden",name:"webId",value:s(t).webId},null,8,ht),o(Be,{"v-cc-config":s(t).ccConfig,"default-thresholds":s(t).defaultThresholds},null,8,["v-cc-config","default-thresholds"]),o(ee,{class:"mt-4"})]),_:1},8,["onSuccess"])])):c("",!0),s(t).featureIsOn?c("",!0):(r(),m("div",ft,[o(Z)]))]),_:1},8,["ctx"]))}};export{os as default};
